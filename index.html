<!DOCTYPE html>
<html lang="fr">

<head>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>PokéBinder</h1>

  <div class="binder-container">
    <button class="nav-arrow nav-left" onclick="previousPage()" title="Page précédente">‹</button>
    <div class="binder-content">
      <div class="page-indicator" id="pageIndicator">Page 1</div>
      <div class="binder-page" id="binderPage"></div>
    </div>
    <button class="nav-arrow nav-right" onclick="nextPage()" title="Page suivante">›</button>
  </div>

  <h2>Galerie de cartes</h2>
  <div class="filter-controls">

    <label for="seriesFilter">Extension:</label>
    <select id="seriesFilter" onchange="filterSets()">
      <option value="sv">Scarlet & Violet</option>
      <option value="swsh">Sword & Shield</option>
      <option value="wz">Wizard</option>
    </select>

    <label for="setFilter">Extension:</label>
    <select id="setFilter" onchange="changeSet()">
      <option value="" disabled selected hidden>Choose a set…</option>
      <!-- Scarlet & Violet -->
      <option value="sv8" data-group="sv">Surging Sparks (SV8)</option>
      <option value="sv7" data-group="sv">Stellar Crown (SV7)</option>
      <option value="sv6" data-group="sv">Twilight Masquerade (SV6)</option>
      <option value="sv5" data-group="sv">Temporal Forces (SV5)</option>
      <option value="sv4" data-group="sv">Paradox Rift (SV4)</option>
      <option value="sv3pt5" data-group="sv">Paldean Fates (SV3.5)</option>
      <option value="sv3" data-group="sv">Obsidian Flames (SV3)</option>
      <option value="sv2" data-group="sv">Paldea Evolved (SV2)</option>
      <option value="sv1" data-group="sv">Scarlet & Violet (SV1)</option>

      <!-- Sword & Shield -->
      <option value="swsh12" data-group="swsh">Silver Tempest (SWSH12)</option>
      <option value="swsh11" data-group="swsh">Lost Origin (SWSH11)</option>
      <option value="swsh10" data-group="swsh">Astral Radiance (SWSH10)</option>

      <!-- Unrelated or legacy sets -->
      <option value="basep" data-group="wz">Wizards Black Star Promos (PR)</option>
      <option value="base2" data-group="wz">Jungle (JU)</option>
      <option value="base1" data-group="wz">Base Set (BS)</option>
    </select>


    <label for="searchInput">Recherche:</label>
    <input type="text" id="searchInput" class="search-input" placeholder="Nom de la carte..." oninput="filterCards()">

    <label for="cardTypeFilter">Type:</label>
    <select id="cardTypeFilter" onchange="filterCards()">
      <option value="all">Toutes les cartes</option>
      <option value="Grass">Plante</option>
      <option value="Fire">Feu</option>
      <option value="Water">Eau</option>
      <option value="Lightning">Électrik</option>
      <option value="Psychic">Psy</option>
      <option value="Fighting">Combat</option>
      <option value="Darkness">Ténèbres</option>
      <option value="Metal">Métal</option>
      <option value="Dragon">Dragon</option>
      <option value="Fairy">Fée</option>
      <option value="Colorless">Incolore</option>
      <option value="Trainer">Dresseur</option>
      <option value="Energy">Énergie</option>
    </select>

    <label for="rarityFilter">Rareté:</label>
    <select id="rarityFilter" onchange="filterCards()">
      <option value="all">Toutes</option>
      <option value="Common">Commune</option>
      <option value="Uncommon">Peu commune</option>
      <option value="Rare">Rare</option>
      <option value="Ultra Rare">Ultra rare</option>
    </select>
  </div>
  <div class="gallery" id="gallery"></div>

  <div class="stats" id="stats">
    <div class="stat-item">
      Cartes placées: <span id="placedCount">0</span>
    </div>
    <div class="stat-item">
      Emplacements libres: <span id="freeCount">90</span>
    </div>
  </div>

  <div class="modal" id="slotModal">
    <div class="modal-content">
      <h3>Choisir un emplacement - Page <span id="modalPageNumber"></span></h3>
      <div class="modal-slots" id="modalSlots"></div>
      <div>
        <button class="clear-btn" onclick="clearCurrentPage()">Vider la page</button>
        <button class="close-btn" onclick="closeModal()">Annuler</button>
      </div>
    </div>
  </div>

  <div class="zoom-modal" id="zoomModal" onclick="closeZoom()">
    <img id="zoomedCard" alt="Carte agrandie">
  </div>

  <script>
    const API_KEY = "5a891e4a-29b0-4a74-b803-e1caaa949069";
    const binderPages = [];
    let currentPageIndex = 0;
    let selectedCardURL = null;
    let lastInsertedIndex = null;
    let allCards = [];
    let filteredCards = [];
    let currentSet = "sv8";

    function initBinderPages(totalPages = 10) {
      for (let i = 0; i < totalPages; i++) {
        binderPages.push(new Array(9).fill(null));
      }
    }

    function renderPage() {
      const binder = document.getElementById("binderPage");
      binder.innerHTML = "";
      const slots = binderPages[currentPageIndex];

      slots.forEach((url, i) => {
        const slot = document.createElement("div");
        slot.classList.add("slot");
        slot.dataset.index = i;

        if (url) {
          slot.classList.add("occupied");
          const img = document.createElement("img");
          img.src = url;

          if (i === lastInsertedIndex) {
            img.classList.add("insert-animation");
            slot.classList.add("last-inserted");
            // Remove the highlight after animation
            setTimeout(() => {
              slot.classList.remove("last-inserted");
              lastInsertedIndex = null;
            }, 2000);
          }

          slot.addEventListener("click", (e) => {
            e.stopPropagation();
            openZoom(url);
          });

          // Double-click to remove card
          slot.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            if (confirm("Retirer cette carte de l'emplacement ?")) {
              binderPages[currentPageIndex][i] = null;
              renderPage();
              updateStats();
            }
          });

          slot.appendChild(img);
        }

        binder.appendChild(slot);
      });

      updatePageIndicator();
      updateStats();
    }

    function updatePageIndicator() {
      document.getElementById("pageIndicator").textContent = `Page ${currentPageIndex + 1}`;

      const prevBtn = document.querySelector('.nav-left');
      const nextBtn = document.querySelector('.nav-right');

      prevBtn.disabled = currentPageIndex === 0;
      nextBtn.disabled = currentPageIndex === binderPages.length - 1;
    }

    function updateStats() {
      let totalPlaced = 0;
      binderPages.forEach(page => {
        page.forEach(slot => {
          if (slot !== null) totalPlaced++;
        });
      });

      const totalSlots = binderPages.length * 9;
      const freeSlots = totalSlots - totalPlaced;

      document.getElementById("placedCount").textContent = totalPlaced;
      document.getElementById("freeCount").textContent = freeSlots;
    }

    function previousPage() {
      if (currentPageIndex > 0) {
        const binder = document.getElementById("binderPage");
        binder.classList.add("page-flip");

        setTimeout(() => {
          currentPageIndex--;
          renderPage();
          binder.classList.remove("page-flip");
        }, 150);
      }
    }

    function nextPage() {
      if (currentPageIndex < binderPages.length - 1) {
        const binder = document.getElementById("binderPage");
        binder.classList.add("page-flip");

        setTimeout(() => {
          currentPageIndex++;
          renderPage();
          binder.classList.remove("page-flip");
        }, 150);
      }
    }

    function filterSets() {
      const blockValue = document.getElementById("seriesFilter").value;
      const setSelect = document.getElementById("setFilter");

      let hasVisibleOption = false;

      Array.from(setSelect.options).forEach(option => {
        if (option.dataset.group === blockValue || option.dataset.group === "other") {
          option.hidden = false;
          hasVisibleOption = true;
        } else {
          option.hidden = true;
        }
      });

      // Clear selection
      setSelect.selectedIndex = -1;

      // Enable or disable the select based on available options
      setSelect.disabled = !hasVisibleOption;
    }


    function changeSet() {
      currentSet = document.getElementById("setFilter").value;
      fetchCards();
      // Clear current filters when switching sets
      document.getElementById("searchInput").value = "";
      document.getElementById("cardTypeFilter").value = "all";
      document.getElementById("rarityFilter").value = "all";
    }

    function fetchCards() {
      console.log(`Fetching cards from set: ${currentSet}...`);

      // Show loading indicator
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = '<div class="loading"></div><span>Chargement des cartes...</span>';

      fetch(`https://api.pokemontcg.io/v2/cards?q=set.id:${currentSet}&pageSize=250`, {
        headers: {"X-Api-Key": API_KEY}
      })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          const cards = data.data
            .filter(c => c.images?.small)
            .sort((a, b) => Number(a.number) - Number(b.number));

          renderGallery(cards);
        })
        .catch(err => {
          console.error("Erreur API :", err);
          gallery.innerHTML = '<p style="color: #ff6b6b;">Erreur de chargement des cartes. Veuillez réessayer.</p>';
        });
    }

    function renderGallery(cards) {
      allCards = cards;
      filteredCards = cards;
      updateGalleryDisplay();
    }

    function updateGalleryDisplay() {
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      if (filteredCards.length === 0) {
        gallery.innerHTML = '<p style="color: #ccc;">Aucune carte trouvée.</p>';
        return;
      }

      filteredCards.forEach(card => {
        const img = document.createElement("img");
        img.src = card.images.small;
        img.alt = card.name;
        img.title = `${card.name} - ${card.rarity || 'Rareté inconnue'}`;
        img.classList.add("card");
        img.addEventListener("click", () => openSlotModal(card.images.small));
        gallery.appendChild(img);
      });
    }

    function filterCards() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const typeFilter = document.getElementById("cardTypeFilter").value;
      const rarityFilter = document.getElementById("rarityFilter").value;

      filteredCards = allCards.filter(card => {
        const matchesSearch = card.name.toLowerCase().includes(searchTerm);

        let matchesType = true;
        if (typeFilter !== "all") {
          if (typeFilter === "Trainer") {
            matchesType = card.supertype === "Trainer";
          } else if (typeFilter === "Energy") {
            matchesType = card.supertype === "Energy";
          } else {
            matchesType = card.types && card.types.includes(typeFilter);
          }
        }

        let matchesRarity = true;
        if (rarityFilter !== "all") {
          matchesRarity = card.rarity === rarityFilter;
        }

        return matchesSearch && matchesType && matchesRarity;
      });

      updateGalleryDisplay();
    }

    function openSlotModal(cardURL) {
      selectedCardURL = cardURL;
      const modal = document.getElementById("slotModal");
      modal.classList.add("active");
      document.getElementById("modalPageNumber").textContent = currentPageIndex + 1;
      document.body.style.overflow = "hidden";
      renderModalSlots();
    }

    function closeModal() {
      const modal = document.getElementById("slotModal");
      modal.classList.remove("active");
      document.body.style.overflow = "auto";
      selectedCardURL = null;
    }

    function clearCurrentPage() {
      if (confirm(`Êtes-vous sûr de vouloir vider toute la page ${currentPageIndex + 1} ?`)) {
        binderPages[currentPageIndex].fill(null);
        renderPage();
        renderModalSlots();
        updateStats();
      }
    }

    function renderModalSlots() {
      const container = document.getElementById("modalSlots");
      container.innerHTML = "";

      const slots = binderPages[currentPageIndex];

      slots.forEach((url, i) => {
        const modalSlot = document.createElement("div");
        modalSlot.classList.add("modal-slot");
        modalSlot.dataset.index = i;

        if (url) {
          modalSlot.classList.add("occupied");
          const img = document.createElement("img");
          img.src = url;
          modalSlot.appendChild(img);
        }

        modalSlot.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Place the card
          binderPages[currentPageIndex][i] = selectedCardURL;
          lastInsertedIndex = i;
          
          // Update everything
          renderPage();
          updateStats();
          
          // Close the modal
          closeModal();

          // Smooth scroll to binder area
          setTimeout(() => {
            const binderContainer = document.querySelector(".binder-container");
            if (binderContainer) {
              binderContainer.scrollIntoView({behavior: "smooth", block: "center"});
            }
          }, 100);
        });

        container.appendChild(modalSlot);
      });
    }

    function openZoom(cardURL) {
      const zoomModal = document.getElementById("zoomModal");
      const zoomedCard = document.getElementById("zoomedCard");

      zoomedCard.src = cardURL;
      zoomModal.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function closeZoom() {
      const zoomModal = document.getElementById("zoomModal");
      zoomModal.classList.remove("active");
      document.body.style.overflow = "auto";
    }


    
    // Handle window resize for responsive updates
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        renderPage();
      }, 150);
    });

    // Prevent zoom modal from closing when clicking on the image
    document.getElementById("zoomedCard").addEventListener("click", (e) => {
      e.stopPropagation();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (document.getElementById("slotModal").classList.contains("active") ||
        document.getElementById("zoomModal").classList.contains("active")) {
        if (e.key === 'Escape') {
          closeModal();
          closeZoom();
        }
        return;
      }

      if (e.key === 'ArrowLeft' && currentPageIndex > 0) {
        previousPage();
      } else if (e.key === 'ArrowRight' && currentPageIndex < binderPages.length - 1) {
        nextPage();
      }
    });

    // Initialize app
    initBinderPages(20);
    renderPage();

    document.addEventListener("DOMContentLoaded", () => {
      filterSets();
    });
  </script>
</body>

</html>